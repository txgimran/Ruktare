<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’° Earn & Withdraw</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f5f5f5;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .json-response {
            background: white;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            overflow: auto;
        }

        /* Hide everything else for directref mode */
        .container, .card, .header, .balance-card, .btn, .referral-section, .modal, .notification {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // =============== URL PARSING ===============
        function getUrlParams() {
            const params = {};
            const query = window.location.search.substring(1);
            const pairs = query.split('&');
            
            pairs.forEach(pair => {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[key] = decodeURIComponent(value);
                }
            });
            
            return params;
        }
        
        // =============== CONFIGURATION ===============
        const STORAGE_KEY = 'ref_earn_multi_bot';
        
        // =============== STORAGE FUNCTIONS ===============
        function getBotData(botToken) {
            const key = `${STORAGE_KEY}_${botToken}`;
            const stored = localStorage.getItem(key);
            
            if (stored) {
                return JSON.parse(stored);
            } else {
                return {
                    users: {},
                    referrals: {},
                    settings: {
                        perRef: 3,
                        minWd: 10,
                        maxWd: 100,
                        dailyLimit: 1,
                        adminPassword: 'admin123',
                        botName: 'EarnBot',
                        adminId: '',
                        botUsername: '',
                        deviceLock: true
                    },
                    withdrawals: []
                };
            }
        }
        
        function saveBotData(botToken, data) {
            const key = `${STORAGE_KEY}_${botToken}`;
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        // =============== USER FUNCTIONS ===============
        function getUserData(botToken, userId) {
            const data = getBotData(botToken);
            
            if (!data.users[userId]) {
                data.users[userId] = {
                    balance: 0,
                    totalEarned: 0,
                    totalWithdrawn: 0,
                    wdToday: 0,
                    refs: 0,
                    refBy: null,
                    banned: false,
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    devices: [],
                    referralCode: generateReferralCode(userId)
                };
                saveBotData(botToken, data);
            } else {
                data.users[userId].lastActive = new Date().toISOString();
                saveBotData(botToken, data);
            }
            
            return data.users[userId];
        }
        
        // =============== REFERRAL CODE SYSTEM ===============
        function generateReferralCode(userId) {
            const num = parseInt(userId) || Math.floor(Math.random() * 1000000);
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            let temp = num;
            
            while (temp > 0) {
                code = chars[temp % 36] + code;
                temp = Math.floor(temp / 36);
            }
            
            return code || 'A1B2C3';
        }
        
        // =============== DEVICE TRACKING ===============
        class DeviceTracker {
            static getDeviceId() {
                const components = [
                    navigator.userAgent,
                    navigator.platform,
                    screen.width + 'x' + screen.height,
                    navigator.language,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || '1'
                ];
                
                let hash = 0;
                for (let i = 0; i < components.length; i++) {
                    const str = components[i];
                    for (let j = 0; j < str.length; j++) {
                        hash = ((hash << 5) - hash) + str.charCodeAt(j);
                        hash = hash & hash;
                    }
                }
                
                return 'device_' + Math.abs(hash).toString(16);
            }
            
            static checkDevice(botToken, userId) {
                const currentDeviceId = this.getDeviceId();
                const storedDeviceId = this.getStoredDeviceId(botToken, userId);
                
                if (!storedDeviceId) {
                    this.storeDevice(botToken, userId, currentDeviceId);
                    return {
                        allowed: true,
                        isNewDevice: true,
                        deviceId: currentDeviceId
                    };
                }
                
                if (currentDeviceId === storedDeviceId) {
                    return {
                        allowed: true,
                        isNewDevice: false,
                        deviceId: currentDeviceId
                    };
                } else {
                    return {
                        allowed: false,
                        isNewDevice: false,
                        currentDeviceId: currentDeviceId,
                        storedDeviceId: storedDeviceId,
                        message: 'Device change detected! Only 1 device allowed.'
                    };
                }
            }
            
            static getStoredDeviceId(botToken, userId) {
                const key = `${STORAGE_KEY}_${botToken}_${userId}_device`;
                return localStorage.getItem(key);
            }
            
            static storeDevice(botToken, userId, deviceId) {
                const key = `${STORAGE_KEY}_${botToken}_${userId}_device`;
                localStorage.setItem(key, deviceId);
                
                const data = getBotData(botToken);
                if (!data.users[userId]) {
                    data.users[userId] = {};
                }
                if (!data.users[userId].devices) {
                    data.users[userId].devices = [];
                }
                
                const deviceInfo = {
                    id: deviceId,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    platform: navigator.platform
                };
                
                const exists = data.users[userId].devices.some(d => d.id === deviceId);
                if (!exists) {
                    data.users[userId].devices.push(deviceInfo);
                    saveBotData(botToken, data);
                }
            }
        }
        
        // =============== SECURE REFERRAL PROCESSING ===============
        function processReferral(botToken, newUserId, referrerId) {
            console.log(`Processing referral: ${newUserId} referred by ${referrerId}`);
            
            const data = getBotData(botToken);
            
            // Check device if enabled
            if (data.settings.deviceLock) {
                const deviceCheck = DeviceTracker.checkDevice(botToken, newUserId);
                if (!deviceCheck.allowed) {
                    return { 
                        status: 'failed', 
                        message: deviceCheck.message 
                    };
                }
                DeviceTracker.storeDevice(botToken, newUserId, deviceCheck.deviceId);
            }
            
            // Basic validation
            if (newUserId === referrerId) {
                return { status: 'failed', message: 'You cannot refer yourself!' };
            }
            
            // Check if already referred
            if (data.users[newUserId]?.refBy) {
                return { 
                    status: 'failed', 
                    message: `User already referred by ${data.users[newUserId].refBy}` 
                };
            }
            
            const referralKey = `${referrerId}_${newUserId}`;
            if (data.referrals[referralKey]) {
                return { status: 'failed', message: 'Referral already processed!' };
            }
            
            // Initialize referrer if not exists
            if (!data.users[referrerId]) {
                data.users[referrerId] = {
                    balance: 0,
                    totalEarned: 0,
                    totalWithdrawn: 0,
                    wdToday: 0,
                    refs: 0,
                    refBy: null,
                    banned: false,
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    devices: [],
                    referralCode: generateReferralCode(referrerId)
                };
            }
            
            // Give bonus
            const bonusAmount = data.settings.perRef || 3;
            data.users[referrerId].balance += bonusAmount;
            data.users[referrerId].totalEarned += bonusAmount;
            data.users[referrerId].refs += 1;
            
            // Create/Update new user
            if (!data.users[newUserId]) {
                data.users[newUserId] = {
                    balance: 0,
                    totalEarned: 0,
                    totalWithdrawn: 0,
                    wdToday: 0,
                    refs: 0,
                    refBy: referrerId,
                    banned: false,
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    devices: [],
                    referralCode: generateReferralCode(newUserId)
                };
            } else {
                data.users[newUserId].refBy = referrerId;
            }
            
            // Record referral
            data.referrals[referralKey] = {
                date: new Date().toISOString(),
                amount: bonusAmount,
                device: DeviceTracker.getDeviceId()
            };
            
            saveBotData(botToken, data);
            
            console.log(`Success! â‚¹${bonusAmount} added to ${referrerId}`);
            
            return { 
                status: 'success', 
                message: 'Money sent to referrer'
            };
        }
        
        // =============== SIMPLE DIRECTREF RESPONSE ===============
        function renderDirectRef(config) {
            // Process the referral
            const result = processReferral(config.botToken, config.uid, config.ref);
            
            // Get user data for the response
            const data = getBotData(config.botToken);
            const user = data.users[config.uid] || {
                balance: 0,
                refs: 0,
                referralCode: generateReferralCode(config.uid)
            };
            
            // Create the JSON response object
            const response = {
                status: result.status,
                message: result.message,
                user: {
                    id: config.uid,
                    balance: user.balance,
                    referrals: user.refs || 0,
                    referral_code: user.referralCode || generateReferralCode(config.uid)
                }
            };
            
            // Display as plain JSON with no styling
            document.getElementById('app').innerHTML = `
                <div class="json-response">${JSON.stringify(response, null, 2)}</div>
            `;
            
            // Also log to console for debugging
            console.log('DirectRef Response:', response);
        }
        
        // =============== MAIN RENDER FUNCTION ===============
        function renderApp() {
            const params = getUrlParams();
            const config = {
                mode: params.api,
                uid: params.uid,
                token: params.token,
                botToken: params.token,
                ref: params.ref
            };
            
            console.log('Config:', config);
            
            if (config.mode === 'directref' && config.uid && config.ref && config.token) {
                renderDirectRef(config);
            } else {
                // For other modes, show appropriate response
                document.getElementById('app').innerHTML = `
                    <div class="json-response">{
  "status": "error",
  "message": "Invalid parameters. Use: ?api=directref&uid=USER_ID&token=BOT_TOKEN&ref=REFERRER_ID"
}</div>
                `;
            }
        }
        
        // =============== INITIALIZE ===============
        window.onload = function() {
            renderApp();
        };
    </script>
</body>
  </html>
