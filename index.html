<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’° EarnBot - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 450px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; font-size: 24px; }
        .user-id { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; font-size: 14px; color: #666; margin-top: 10px; display: inline-block; }
        .balance-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; margin: 20px 0; }
        .balance-label { font-size: 16px; opacity: 0.9; }
        .balance-amount { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .stat-box { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; margin: 10px 0; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #00b09b, #96c93d); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .referral-box { background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px dashed #dee2e6; }
        .referral-link { background: white; padding: 15px; border-radius: 10px; font-family: monospace; word-break: break-all; margin: 15px 0; }
        .copy-btn { background: #6c757d; color: white; padding: 12px; border-radius: 8px; border: none; width: 100%; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="app">
            <div class="card">
                <div class="header">
                    <h1>ðŸ’° EarnBot</h1>
                    <div class="user-id">Loading...</div>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p>Loading your dashboard...</p>
                </div>
            </div>
        </div>
    </div>

<script>
// =============== CONFIGURATION ===============
const BOT_TOKEN = "8188013971:AAEqtrNRwXGCRmrFz7gytmZayXuzZR20J0I";
const STORAGE_KEY = "earnbot_data_v2";

// =============== GET URL PARAMETERS ===============
function getUrlParams() {
    const params = {};
    const query = window.location.search.substring(1);
    if (!query) return params;
    
    query.split('&').forEach(pair => {
        const [key, value] = pair.split('=');
        if (key && value) {
            params[key] = decodeURIComponent(value);
        }
    });
    
    return params;
}

// =============== LOAD/SAVE DATA ===============
function loadData() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.error("Error loading data:", e);
    }
    
    // Default data structure
    return {
        users: {},
        referrals: {},
        settings: {
            perRef: 3,
            minWd: 10,
            maxWd: 100,
            dailyLimit: 1,
            adminId: "6565456198",
            botName: "EarnBot"
        },
        withdrawals: []
    };
}

function saveData(data) {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        return true;
    } catch (e) {
        console.error("Error saving data:", e);
        return false;
    }
}

// =============== PROCESS REFERRAL (FOR JSON API) ===============
function processReferralForApi(userId, referrerId) {
    console.log("Processing referral:", userId, "->", referrerId);
    
    const data = loadData();
    
    // Skip if same user
    if (userId === referrerId) {
        return {
            status: "failed",
            message: "Cannot refer yourself",
            code: "SELF_REFERRAL"
        };
    }
    
    // Check if user already referred
    if (data.users[userId] && data.users[userId].refBy) {
        return {
            status: "failed", 
            message: `Already referred by ${data.users[userId].refBy}`,
            code: "ALREADY_REFERRED"
        };
    }
    
    // Ensure referrer exists
    if (!data.users[referrerId]) {
        data.users[referrerId] = {
            balance: 0,
            totalEarned: 0,
            totalWithdrawn: 0,
            refs: 0,
            refBy: null,
            joinDate: new Date().toISOString()
        };
    }
    
    // Ensure user exists
    if (!data.users[userId]) {
        data.users[userId] = {
            balance: 0,
            totalEarned: 0,
            totalWithdrawn: 0,
            refs: 0,
            refBy: referrerId,
            joinDate: new Date().toISOString()
        };
    } else {
        data.users[userId].refBy = referrerId;
    }
    
    // Give bonus
    const bonus = data.settings.perRef || 3;
    data.users[referrerId].balance += bonus;
    data.users[referrerId].totalEarned += bonus;
    data.users[referrerId].refs += 1;
    
    // Save referral record
    const refKey = `${referrerId}_${userId}`;
    data.referrals[refKey] = {
        date: new Date().toISOString(),
        amount: bonus,
        user: userId,
        referrer: referrerId
    };
    
    // Save data
    saveData(data);
    
    console.log("Referral processed. New balance:", data.users[referrerId].balance);
    
    return {
        status: "success",
        message: `â‚¹${bonus} credited to ${referrerId}`,
        amount: bonus,
        user_id: userId,
        referrer_id: referrerId,
        referrer_balance: data.users[referrerId].balance,
        referrer_total_refs: data.users[referrerId].refs,
        timestamp: new Date().toISOString()
    };
}

// =============== HANDLE API REQUESTS ===============
function handleApiRequest() {
    const params = getUrlParams();
    
    // JSON API for bot
    if (params.api === "json" && params.uid && params.ref && params.token === BOT_TOKEN) {
        const result = processReferralForApi(params.uid, params.ref);
        
        // Return ONLY JSON
        document.head.innerHTML = '<meta charset="UTF-8"><title>API Response</title>';
        document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        document.body.style.padding = "20px";
        document.body.style.fontFamily = "monospace";
        
        return true;
    }
    
    return false;
}

// =============== SHOW USER DASHBOARD ===============
function showUserDashboard(userId) {
    const data = loadData();
    const user = data.users[userId] || {
        balance: 0,
        totalEarned: 0,
        totalWithdrawn: 0,
        refs: 0,
        refBy: null
    };
    
    // Generate referral link
    const botUsername = "Cashbeee_bot"; // Change to your bot username
    const referralLink = `https://t.me/${botUsername}?start=${userId}`;
    
    document.getElementById("app").innerHTML = `
        <div class="card">
            <div class="header">
                <h1>ðŸ’° ${data.settings.botName}</h1>
                <div class="user-id">ID: ${userId}</div>
                ${user.refBy ? `<div style="margin-top: 5px; font-size: 13px; color: #666;">ðŸ‘¤ Referred by: ${user.refBy}</div>` : ""}
            </div>
            
            <div class="balance-card">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount">â‚¹${user.balance}</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${user.refs || 0}</div>
                        <div class="stat-label">Referrals</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">â‚¹${user.totalEarned || 0}</div>
                        <div class="stat-label">Earned</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">â‚¹${user.totalWithdrawn || 0}</div>
                        <div class="stat-label">Withdrawn</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="showWithdrawModal()">
                ðŸ’¸ Withdraw Money
            </button>
            <p style="text-align: center; margin-top: 10px; font-size: 13px; color: #666;">
                Min: â‚¹${data.settings.minWd} â€¢ Max: â‚¹${data.settings.maxWd}
            </p>
            
            <div class="referral-box">
                <div style="font-weight: bold; margin-bottom: 10px;">ðŸŽ¯ Invite Friends & Earn â‚¹${data.settings.perRef}</div>
                <div class="referral-link">${referralLink}</div>
                <button class="copy-btn" onclick="copyToClipboard('${referralLink}')">ðŸ“‹ Copy Link</button>
                <button class="btn btn-secondary" onclick="window.open('${referralLink}', '_blank')" style="margin-top: 10px;">
                    ðŸ“¤ Open in Telegram
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
                ðŸ’¡ Share your link to earn â‚¹${data.settings.perRef} per referral
            </div>
        </div>
    `;
}

// =============== UTILITY FUNCTIONS ===============
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("âœ… Link copied to clipboard!");
    });
}

function showWithdrawModal() {
    alert("Withdraw feature coming soon!\n\nMinimum: â‚¹10\nUPI payments only");
}

// =============== INITIALIZE ===============
function init() {
    const params = getUrlParams();
    
    // Handle API requests first
    if (handleApiRequest()) {
        return;
    }
    
    // Show user dashboard
    if (params.api === "user" && params.uid && params.token === BOT_TOKEN) {
        showUserDashboard(params.uid);
    } 
    // Show admin panel
    else if (params.api === "admin" && params.token === BOT_TOKEN) {
        showAdminPanel();
    }
    // Default page
    else {
        document.getElementById("app").innerHTML = `
            <div class="card">
                <div class="header">
                    <h1>ðŸ’° EarnBot Dashboard</h1>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ¤–</div>
                    <p>Access via Telegram bot only</p>
                    <p style="font-size: 14px; color: #666; margin-top: 20px;">
                        Use your bot to get dashboard link
                    </p>
                </div>
            </div>
        `;
    }
}

// Start the app
window.onload = init;
</script>
</body>
  </html>
